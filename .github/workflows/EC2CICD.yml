## GitHub Actions ëŒ€ì‹œë³´ë“œì— í‘œì‹œë  ì›Œí¬í”Œë¡œ ì´ë¦„
name: EC2 CI/CD
## ì‹¤í–‰ ì‹œ "Deploy to [ëŒ€ìƒ] by @ì‚¬ìš©ìëª…" í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
run-name: Deploy to ${{ inputs.deploy_target }} by @${{ github.actor }}

## íŠ¸ë¦¬ê±° ì„¤ì • (ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì›Œí¬í”Œë¡œ ì‹¤í–‰)
on:
  push:
    branches: [ "main", "feature/terraform" ]  ## main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‹¤í–‰
#  pull_request:         ## ì£¼ì„ í•´ì œ ì‹œ main ë¸Œëœì¹˜ PR ì´ë²¤íŠ¸ë¡œë„ ì‹¤í–‰
#    branches: [ "main" ]

env:
  BASTION: ec2-3-34-132-193.ap-northeast-2.compute.amazonaws.com
  APPS: 10.0.4.166, 10.0.4.61
  AWS_ROLE_ARN: arn:aws:iam::350386634560:role/github-actions-deploy-role
  AWS_REGION: ap-northeast-2
  IMAGE_TAG: ${{ github.sha }}
  IMAGE_NAME: shinemuscat-api

jobs:
  build:
    ## ê¹ƒí—™ í˜¸ìŠ¤í‹°ë“œ
    runs-on: ubuntu-latest
    permissions:
      id-token: write     # âœ… OIDC ì¸ì¦ì„ ìœ„í•´ GitHubê°€ ID í† í°ì„ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆë„ë¡ í—ˆìš©
      contents: read      # âœ… (ì˜ˆ: ì½”ë“œ checkout ë“±) ë¦¬í¬ì§€í† ë¦¬ì˜ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìˆë„ë¡ í—ˆìš©
    outputs:
      ecr_registry: ${{ steps.ecr.outputs.registry }}

    steps:
      ## ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ (í•„ìˆ˜ ì´ˆê¸° ë‹¨ê³„)
      - uses: actions/checkout@v4  ## ë²„ì „ v4ì˜ ê³µì‹ ì²´í¬ì•„ì›ƒ ì•¡ì…˜ ì‚¬ìš©

      ## ubuntu ì„œë²„ì— javaë¥¼ ì„¤ì¹˜í•˜ê¸° ë•Œë¬¸ì— í•„ìš”í•˜ì§€ ì•Šë‹¤ ìƒê°ë˜ì–´ ì£¼ì„
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      ## java ë²„ì „ í™•ì¸
      - name: Check Java Version
        run: java -version

      ## gradleì˜ ì‹¤í–‰ê¶Œí•œ ë¶€ì—¬ì™€ build ìˆ˜í–‰
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      ## Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: ./gradlew clean build --exclude-task test

      ## ë¹Œë“œí•´ì„œ ìƒê¸´ JAR íŒŒì¼ì„ ê¹ƒí—ˆë¸Œ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
#      - name: Upload build artifact
#        uses: actions/upload-artifact@v4
#        with:
#          name: github_action
#          path: |
#            build/libs/github_action.jar
#            Dockerfile

      # AWS Credentials
      - name: Configure AWS credentials ğŸ”‘
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ECR ì„¤ì¹˜
      - name: Setup ECR Repository
        uses: deploy-actions/setup-ecr@v1
        with:
          RepositoryName: ecr

      # Docker buildx Setup
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker # ì´ê±°ë¥¼ ì„¤ì •í•´ì•¼ ìë™ìœ¼ë¡œ ë©€í‹° í”Œë«í¼ manifestê°€ ë§Œë“¤ì–´ì§€ì§€ ì•ŠëŠ”ë‹¤. (ëª…ì‹œ í•´ì¤˜ì•¼í•¨)

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: ${{ steps.ecr.outputs.registry }}/ecr:${{ env.IMAGE_TAG }}

  deploy:
    runs-on: ubuntu-latest
    needs: [ build ] ## buildê°€ ìˆ˜í–‰ë˜ì–´ì•¼ë§Œ deployê°€ ìˆ˜í–‰
    steps:
      ## ë¹Œë“œì‘ì—…í•œ JARíŒŒì¼ì„ ì•„í‹°í™íŠ¸ì—ì„œ ë‹¤ìš´ë¡œë“œ
#      - name: Download build artifact
#        uses: actions/download-artifact@v4
#        with:
#          name: github_action
#          path: .

      - name: Login to Amazon ECR
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{env.APPS}}
          key: ${{secrets.SSH_PRIVATE_KEY}}
          username: ${{ secrets.USER }}
          port: 22
          proxy_host: ${{ env.BASTION }} # EC2 Public IP
          proxy_username: ${{ secrets.USER }}
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}
          proxy_port: 22
          script: |
            aws ecr get-login-password --region ${{env.AWS_REGION}} | docker login --username AWS --password-stdin ${{ needs.build.outputs.ecr_registry }}/ecr

      - name: Pull Docker Image From ECR
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{env.APPS}}
          key: ${{secrets.SSH_PRIVATE_KEY}}
          username: ubuntu
          port: 22
          proxy_host: ${{ env.BASTION }} # EC2 Public IP
          proxy_username: ${{ secrets.USER }}
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}
          proxy_port: 22
          script: |
            docker pull ${{ needs.build.outputs.ecr_registry }}/ecr:${{env.IMAGE_TAG}}
            docker images

      - name: Pull to ECR and Start Application
        uses: appleboy/ssh-action@master # github actionì˜ ssh ì›ê²© ì ‘ì†
        with:
          host: ${{ env.APPS }}
          username: ${{ secrets.USER }}
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          proxy_host: ${{ env.BASTION }} # EC2 Public IP
          proxy_username: ${{ secrets.USER }}
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}
          proxy_port: 22
          script: |
            docker stop ${{env.IMAGE_NAME}} || true
            docker rm ${{env.IMAGE_NAME}} || true
            docker run -d --name ${{env.IMAGE_NAME}} --env PROFILE=aws -p 8080:8080 ${{ needs.build.outputs.ecr_registry }}/ecr:${{ env.IMAGE_TAG }}
            docker image prune -af
            docker container prune -f