## GitHub Actions ëŒ€ì‹œë³´ë“œì— í‘œì‹œë  ì›Œí¬í”Œë¡œ ì´ë¦„
name: EC2 Deploy
## ì‹¤í–‰ ì‹œ "Deploy to [ëŒ€ìƒ] by @ì‚¬ìš©ìëª…" í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
run-name: Deploy to ${{ inputs.deploy_target }} by @${{ github.actor }}

## íŠ¸ë¦¬ê±° ì„¤ì • (ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì›Œí¬í”Œë¡œ ì‹¤í–‰)
on:
  push:
    branches: [ "main", "feature/terraform" ]  ## main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‹¤í–‰
#  pull_request:         ## ì£¼ì„ í•´ì œ ì‹œ main ë¸Œëœì¹˜ PR ì´ë²¤íŠ¸ë¡œë„ ì‹¤í–‰
#    branches: [ "main" ]

env:
  BASTION: 3.34.255.54
  APPS: 10.0.4.134, 10.0.4.52
  AWS_ROLE_ARN: arn:aws:iam::350386634560:role/github-actions-deploy-role
  AWS_REGION: ap-northeast-2
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build:
    ## ê¹ƒí—™ í˜¸ìŠ¤í‹°ë“œ
    runs-on: ubuntu-latest
    permissions:
      id-token: write     # âœ… OIDC ì¸ì¦ì„ ìœ„í•´ GitHubê°€ ID í† í°ì„ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆë„ë¡ í—ˆìš©
      contents: read      # âœ… (ì˜ˆ: ì½”ë“œ checkout ë“±) ë¦¬í¬ì§€í† ë¦¬ì˜ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìˆë„ë¡ í—ˆìš©

    steps:
      ## ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ (í•„ìˆ˜ ì´ˆê¸° ë‹¨ê³„)
      - uses: actions/checkout@v4  ## ë²„ì „ v4ì˜ ê³µì‹ ì²´í¬ì•„ì›ƒ ì•¡ì…˜ ì‚¬ìš©

      ## ubuntu ì„œë²„ì— javaë¥¼ ì„¤ì¹˜í•˜ê¸° ë•Œë¬¸ì— í•„ìš”í•˜ì§€ ì•Šë‹¤ ìƒê°ë˜ì–´ ì£¼ì„
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      ## java ë²„ì „ í™•ì¸
      - name: Check Java Version
        run: java -version

      ## gradleì˜ ì‹¤í–‰ê¶Œí•œ ë¶€ì—¬ì™€ build ìˆ˜í–‰
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      ## Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: ./gradlew clean build --exclude-task test

      # AWS Credentials
      - name: Configure AWS credentials ğŸ”‘
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ECR ì„¤ì¹˜
      - name: Setup ECR Repository
        uses: deploy-actions/setup-ecr@v1
        with:
          RepositoryName: ecr

      # Docker buildx Setup
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker # ì´ê±°ë¥¼ ì„¤ì •í•´ì•¼ ìë™ìœ¼ë¡œ ë©€í‹° í”Œë«í¼ manifestê°€ ë§Œë“¤ì–´ì§€ì§€ ì•ŠëŠ”ë‹¤. (ëª…ì‹œ í•´ì¤˜ì•¼í•¨)

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: ${{ steps.ecr.outputs.registry }}/ecr:${{ env.IMAGE_TAG }}

  deploy:
    runs-on: ubuntu-latest
    needs: [ build ] ## buildê°€ ìˆ˜í–‰ë˜ì–´ì•¼ë§Œ deployê°€ ìˆ˜í–‰
    permissions:
      id-token: write     # âœ… OIDC ì¸ì¦ì„ ìœ„í•´ GitHubê°€ ID í† í°ì„ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆë„ë¡ í—ˆìš©
      contents: read      # âœ… (ì˜ˆ: ì½”ë“œ checkout ë“±) ë¦¬í¬ì§€í† ë¦¬ì˜ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìˆë„ë¡ í—ˆìš©
    steps:
      # AWS ë¡œê·¸ì¸
      - name: Configure AWS credentials ğŸ”‘
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Start CodeDeploy
        run: |
          aws deploy create-deployment \
              --application-name shinemuscat-codedeploy-app \
              --deployment-group-name shinemuscat-deployment-group \
              --github-location repository=${{ github.repository }},commitId=${{ github.sha }} \
              --description "Auto-deploy from ${{ github.ref_name }}"